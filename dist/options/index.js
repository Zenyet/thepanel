import{a as S,b as ae,D as h,i as C,c as x}from"../chunks/types.js";const T="thecircle_data";async function V(){const e=await chrome.storage.local.get(T);return e[T]?e[T]:{config:h,selectionMenuItems:ae,globalMenuItems:S}}async function te(e){const o={...await V(),...e};await chrome.storage.local.set({[T]:o})}async function Z(e){const t=await V();t.config={...t.config,...e},await te(t)}async function ee(e){await te({globalMenuItems:e})}let u=[],A=null;document.addEventListener("DOMContentLoaded",async()=>{var X;const e=document.getElementById("app-logo");e&&(e.innerHTML=C.logo);const t=document.getElementById("apiProvider"),o=document.getElementById("apiKey"),r=document.getElementById("customApiUrl"),n=document.getElementById("customModel"),s=document.getElementById("customApiUrlGroup"),a=document.getElementById("customModelGroup"),c=document.getElementById("apiKeyHelpText"),m=document.getElementById("useStreaming"),g=document.getElementById("preferredLanguage"),y=document.getElementById("summaryLanguage"),k=document.getElementById("popoverPosition"),v=document.getElementById("theme"),d=document.getElementById("saveBtn"),f=document.getElementById("resetBtn"),M=document.getElementById("shortcutDisplay"),w=document.getElementById("recordShortcutBtn"),Q=document.getElementById("shortcutHelpText"),U=document.getElementById("screenshotSaveToFile"),D=document.getElementById("screenshotCopyToClipboard"),$=document.getElementById("screenshotEnableAI"),K=document.getElementById("screenshotDefaultAIAction"),F=document.getElementById("screenshotEnableImageGen"),L=document.getElementById("imageGenProvider"),q=document.getElementById("customImageGenUrl"),ne=document.getElementById("customImageGenUrlGroup"),H=document.getElementById("imageSize");let O=!1,B="Alt+Tab";const J=await V(),p=J.config,E=p.screenshot||x;u=J.globalMenuItems,u=ce(u,S),t.value=p.apiProvider,o.value=p.apiKey||"",r.value=p.customApiUrl||"",n.value=p.customModel||"",m.checked=p.useStreaming??!0,g.value=p.preferredLanguage,y.value=p.summaryLanguage||"auto",k.value=p.popoverPosition||"above",v.value=p.theme,B=p.shortcut||"Alt+Tab",j(B),_(p.apiProvider),U.checked=E.saveToFile,D.checked=E.copyToClipboard,$.checked=E.enableAI,K.value=E.defaultAIAction,F.checked=E.enableImageGen,L.value=E.imageGenProvider,q.value=E.customImageGenUrl||"",H.value=E.imageSize,N(E.imageGenProvider),P("globalMenuList",u),me(),Y(p.theme),(X=document.getElementById("addGlobalItem"))==null||X.addEventListener("click",()=>{A=null,oe("添加自定义菜单项")}),t.addEventListener("change",()=>{_(t.value)});function _(l){const i=l==="custom";s.style.display=i?"block":"none",a.style.display=i?"block":"none",l==="groq"?c.textContent="使用 Groq 免费服务无需配置 API Key":i?c.textContent="如果你的 API 需要认证，请填写 API Key":c.textContent=`请填写你的 ${l.toUpperCase()} API Key`}function N(l){const i=l==="custom";ne.style.display=i?"block":"none"}L==null||L.addEventListener("change",()=>{N(L.value)}),w==null||w.addEventListener("click",()=>{O?R():re()});function re(){O=!0,w.textContent="取消录制",w.classList.add("bg-red-500/20","border-red-500","text-red-400"),M.classList.add("border-2","border-blue-500","bg-blue-500/10","animate-pulse"),Q.textContent="请按下快捷键组合... (ESC 取消)",document.addEventListener("keydown",W)}function R(){O=!1,w.textContent="录制快捷键",w.classList.remove("bg-red-500/20","border-red-500","text-red-400"),M.classList.remove("border-2","border-blue-500","bg-blue-500/10","animate-pulse"),Q.textContent='点击"录制快捷键"按钮，然后按下你想要的快捷键组合',document.removeEventListener("keydown",W)}function W(l){if(l.preventDefault(),l.stopPropagation(),l.key==="Escape"){R();return}const i=[];(l.ctrlKey||l.metaKey)&&i.push("Ctrl"),l.altKey&&i.push("Alt"),l.shiftKey&&i.push("Shift");const I=l.key;if(!["Control","Alt","Shift","Meta"].includes(I)){const z=I===" "?"Space":I.length===1?I.toUpperCase():I;i.push(z),i.length>=2&&(B=i.join("+"),j(B),R(),b("快捷键已设置，请点击保存按钮"))}}function j(l){if(M){const i=l.split("+");M.innerHTML=i.map((I,z)=>{const se=z<i.length-1?'<span class="text-base text-white/50">+</span>':"";return`<span class="px-4 py-2 rounded-md text-sm font-semibold bg-white/10 border border-white/20">${I}</span>${se}`}).join("")}}d==null||d.addEventListener("click",async()=>{const l=t.value;if(l==="custom"){if(!r.value){b("请填写自定义 API URL","error");return}if(!n.value){b("请填写模型名称","error");return}try{new URL(r.value)}catch{b("API URL 格式不正确","error");return}}const i={saveToFile:U.checked,copyToClipboard:D.checked,enableAI:$.checked,defaultAIAction:K.value,imageQuality:.92,enableImageGen:F.checked,imageGenProvider:L.value,customImageGenUrl:q.value||void 0,imageSize:H.value},I={apiProvider:l,apiKey:o.value||void 0,customApiUrl:r.value||void 0,customModel:n.value||void 0,useStreaming:m.checked,preferredLanguage:g.value,summaryLanguage:y.value,popoverPosition:k.value,theme:v.value,shortcut:B,screenshot:i};Y(I.theme),await Z(I),await ee(u),b("设置已保存","success")}),f==null||f.addEventListener("click",async()=>{await Z(h),await ee(S),t.value=h.apiProvider,o.value="",r.value="",n.value="",m.checked=h.useStreaming,g.value=h.preferredLanguage,y.value=h.summaryLanguage,k.value=h.popoverPosition||"above",v.value=h.theme,Y(h.theme),B=h.shortcut,j(B),_(h.apiProvider),U.checked=x.saveToFile,D.checked=x.copyToClipboard,$.checked=x.enableAI,K.value=x.defaultAIAction,F.checked=x.enableImageGen,L.value=x.imageGenProvider,q.value="",H.value=x.imageSize,N(x.imageGenProvider),u=[...S],P("globalMenuList",u),b("已重置为默认设置","success")})});function ce(e,t){return e.map((o,r)=>{const n=t.find(s=>s.id===o.id);return{...o,enabled:o.enabled??!0,order:o.order??(n==null?void 0:n.order)??r}})}function P(e,t){const o=document.getElementById(e);if(!o)return;const r=[...t].sort((n,s)=>n.order-s.order);o.innerHTML=r.map(n=>{const s=n.isCustom;return`
      <div class="flex items-center gap-3 px-3 py-2.5 rounded-lg bg-white border border-gray-200 dark:bg-white/5 dark:border-white/10 transition-all duration-150 cursor-grab hover:bg-gray-50 hover:border-gray-300 dark:hover:bg-white/10 dark:hover:border-white/15 menu-item-config" draggable="true" data-id="${n.id}">
        <span class="text-sm cursor-grab text-gray-400 dark:text-white/30 select-none tracking-widest hover:text-gray-600 dark:hover:text-white/50 drag-handle">⋮⋮</span>
        <span class="flex items-center justify-center w-[28px] h-[28px] rounded-md bg-gray-100 text-gray-700 dark:bg-white/10 dark:text-white/80 item-icon">${n.customIcon||n.icon}</span>
        <span class="flex-1 text-sm font-medium text-gray-900 dark:text-white/90 item-label">${n.customLabel||n.label}</span>
        <span class="text-xs px-2 py-0.5 rounded bg-gray-100 text-gray-500 dark:bg-white/10 dark:text-white/50 item-action">${n.action}</span>
        <div class="flex items-center gap-2 item-actions">
          ${s?`
            <button class="p-1.5 rounded cursor-pointer border-none bg-transparent text-gray-400 hover:text-gray-900 hover:bg-gray-100 dark:text-white/40 dark:hover:bg-white/10 dark:hover:text-white/80 item-btn edit" data-id="${n.id}" title="编辑">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                <path d="M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z"/>
              </svg>
            </button>
            <button class="p-1.5 rounded cursor-pointer border-none bg-transparent text-gray-400 hover:text-red-600 hover:bg-red-50 dark:text-white/40 dark:hover:bg-red-500/20 dark:hover:text-red-500 item-btn delete" data-id="${n.id}" title="删除">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
              </svg>
            </button>
          `:""}
          <label class="relative inline-block w-[36px] h-[20px] toggle-switch small">
            <input type="checkbox" ${n.enabled?"checked":""} data-id="${n.id}" class="opacity-0 w-0 h-0 peer sr-only">
            <span class="absolute inset-0 cursor-pointer rounded-full bg-gray-200 dark:bg-white/15 transition-all duration-250 before:absolute before:rounded-full before:h-[14px] before:w-[14px] before:left-[3px] before:bottom-[3px] before:bg-white dark:before:bg-white/70 before:transition-all before:duration-250 peer-checked:bg-blue-500 peer-checked:before:translate-x-[16px] peer-checked:before:bg-white toggle-slider"></span>
          </label>
        </div>
      </div>
    `}).join(""),le(e),ie(e),ue(e)}function le(e){const t=document.getElementById(e);if(!t)return;const o=t.querySelectorAll(".menu-item-config");let r=null;o.forEach(n=>{const s=n;s.addEventListener("dragstart",a=>{r=s,setTimeout(()=>s.classList.add("opacity-50","cursor-grabbing","dragging","scale-95"),0),a.dataTransfer.effectAllowed="move"}),s.addEventListener("dragend",()=>{s.classList.remove("opacity-50","cursor-grabbing","dragging","scale-95"),r=null,de(e)}),s.addEventListener("dragover",a=>{a.preventDefault(),a.dataTransfer.dropEffect="move",s.classList.add("border-blue-500/50","bg-blue-500/10","drag-over")}),s.addEventListener("dragleave",()=>{s.classList.remove("border-blue-500/50","bg-blue-500/10","drag-over")}),s.addEventListener("drop",a=>{if(a.preventDefault(),s.classList.remove("border-blue-500/50","bg-blue-500/10","drag-over"),r&&r!==s){const c=s.getBoundingClientRect(),m=c.top+c.height/2;a.clientY<m?t.insertBefore(r,s):t.insertBefore(r,s.nextSibling)}})})}function de(e){const t=document.getElementById(e);if(!t)return;t.querySelectorAll(".menu-item-config").forEach((r,n)=>{const s=r.dataset.id,a=u.find(c=>c.id===s);a&&(a.order=n)})}function ie(e){const t=document.getElementById(e);if(!t)return;t.querySelectorAll(".toggle-switch input").forEach(r=>{r.addEventListener("change",n=>{const s=n.target,a=s.dataset.id,c=u.find(m=>m.id===a);c&&(c.enabled=s.checked)})})}function ue(e){const t=document.getElementById(e);t&&(t.querySelectorAll(".item-btn.edit").forEach(o=>{o.addEventListener("click",()=>{const r=o.dataset.id;if(r){A=r;const n=u.find(s=>s.id===r);n&&oe("编辑自定义菜单项",n)}})}),t.querySelectorAll(".item-btn.delete").forEach(o=>{o.addEventListener("click",()=>{const r=o.dataset.id;r&&(u=u.filter(n=>n.id!==r),P("globalMenuList",u),b("菜单项已删除"))})}))}function me(){const e=document.getElementById("customItemModal"),t=document.getElementById("modalClose"),o=document.getElementById("cancelCustomItem"),r=document.getElementById("saveCustomItem"),n=document.getElementById("customItemAction"),s=document.getElementById("customPromptGroup"),a=document.getElementById("customUrlGroup");ge(),t==null||t.addEventListener("click",G),o==null||o.addEventListener("click",G),e==null||e.addEventListener("click",c=>{c.target===e&&G()}),n==null||n.addEventListener("change",()=>{const c=n.value;s&&(s.style.display=c==="customAI"?"block":"none"),a&&(a.style.display=c==="openUrl"?"block":"none")}),r==null||r.addEventListener("click",()=>{const c=document.getElementById("selectedIcon").value,m=document.getElementById("customItemLabel").value.trim(),g=document.getElementById("customItemAction").value,y=document.getElementById("customPrompt").value.trim(),k=document.getElementById("customUrl").value.trim();if(!c){b("请选择一个图标","error");return}if(!m){b("请输入菜单项名称","error");return}if(g==="customAI"&&!y){b("请输入 AI 提示词","error");return}if(g==="openUrl"&&!k){b("请输入链接地址","error");return}const v=C[c];if(A){const d=u.find(f=>f.id===A);d&&(d.icon=v,d.label=m,d.action=g,g==="customAI"&&(d.customPrompt=y))}else{const d={id:`custom_${Date.now()}`,icon:v,label:m,action:g,enabled:!0,order:u.length,isCustom:!0,customPrompt:g==="customAI"?y:void 0};u.push(d)}P("globalMenuList",u),G(),b(A?"菜单项已更新":"菜单项已添加","success")})}function ge(){const e=document.getElementById("iconPicker");if(!e)return;const t=Object.keys(C);e.innerHTML=t.map(o=>`
    <div class="flex items-center justify-center w-9 h-9 rounded-lg cursor-pointer bg-white/5 border-2 border-transparent text-white/70 transition-all duration-150 hover:bg-white/10 hover:text-white/90 icon-option" data-icon="${o}" title="${o}">
      ${C[o]}
    </div>
  `).join(""),e.querySelectorAll(".icon-option").forEach(o=>{o.addEventListener("click",()=>{e.querySelectorAll(".icon-option").forEach(r=>r.classList.remove("border-blue-500","bg-blue-500/20","text-white","selected")),o.classList.add("border-blue-500","bg-blue-500/20","text-white","selected"),document.getElementById("selectedIcon").value=o.dataset.icon||""})})}function oe(e,t){var k;const o=document.getElementById("customItemModal"),r=document.getElementById("modalTitle"),n=document.getElementById("selectedIcon"),s=document.getElementById("customItemLabel"),a=document.getElementById("customItemAction"),c=document.getElementById("customPrompt"),m=document.getElementById("customUrl"),g=document.getElementById("customPromptGroup"),y=document.getElementById("customUrlGroup");if(r&&(r.textContent=e),t){const v=((k=Object.entries(C).find(([d,f])=>f===t.icon))==null?void 0:k[0])||"";n.value=v,document.querySelectorAll(".icon-option").forEach(d=>{const f=d.dataset.icon===v;d.classList.toggle("selected",f),f?d.classList.add("border-blue-500","bg-blue-500/20","text-white"):d.classList.remove("border-blue-500","bg-blue-500/20","text-white")}),s.value=t.label,a.value=t.action,c.value=t.customPrompt||""}else n.value="",document.querySelectorAll(".icon-option").forEach(v=>v.classList.remove("border-blue-500","bg-blue-500/20","text-white","selected")),s.value="",a.value="customAI",c.value="",m.value="";g&&(g.style.display=a.value==="customAI"?"block":"none"),y&&(y.style.display=a.value==="openUrl"?"block":"none"),o==null||o.classList.add("show")}function G(){const e=document.getElementById("customItemModal");e==null||e.classList.remove("show"),A=null}function Y(e){const t=e==="dark"||e==="system"&&window.matchMedia("(prefers-color-scheme: dark)").matches;document.documentElement.classList.toggle("dark",t)}function b(e,t="success"){const o=document.getElementById("toast");if(o){o.textContent=e;const r=t==="success"?"border-green-500/50":"border-red-500/50";o.className=`fixed bottom-6 left-1/2 px-5 py-3 text-sm rounded-lg pointer-events-none -translate-x-1/2 bg-[#1e1e1e]/95 border text-white/90 shadow-lg transition-all duration-250 backdrop-blur-sm z-[2000] opacity-100 translate-y-0 ${r}`,setTimeout(()=>{o.className="fixed bottom-6 left-1/2 px-5 py-3 text-sm rounded-lg pointer-events-none -translate-x-1/2 translate-y-[100px] bg-[#1e1e1e]/95 border border-white/15 text-white/90 shadow-lg opacity-0 transition-all duration-250 backdrop-blur-sm z-[2000]"},2500)}}
