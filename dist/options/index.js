import{a as C,b as ne,D as w,c as E,i as S}from"../chunks/types.js";const G="thecircle_data";async function j(){const e=await chrome.storage.local.get(G);return e[G]?e[G]:{config:w,selectionMenuItems:ne,globalMenuItems:C}}async function X(e){const t={...await j(),...e};await chrome.storage.local.set({[G]:t})}async function J(e){const o=await j();o.config={...o.config,...e},await X(o)}async function W(e){await X({globalMenuItems:e})}let u=[],A=null;document.addEventListener("DOMContentLoaded",async()=>{var Q;const e=document.getElementById("apiProvider"),o=document.getElementById("apiKey"),t=document.getElementById("customApiUrl"),r=document.getElementById("customModel"),n=document.getElementById("customApiUrlGroup"),s=document.getElementById("customModelGroup"),c=document.getElementById("apiKeyHelpText"),l=document.getElementById("useStreaming"),g=document.getElementById("preferredLanguage"),p=document.getElementById("popoverPosition"),f=document.getElementById("theme"),x=document.getElementById("saveBtn"),v=document.getElementById("resetBtn"),i=document.getElementById("shortcutDisplay"),m=document.getElementById("recordShortcutBtn"),z=document.getElementById("shortcutHelpText"),P=document.getElementById("screenshotSaveToFile"),T=document.getElementById("screenshotCopyToClipboard"),U=document.getElementById("screenshotEnableAI"),D=document.getElementById("screenshotDefaultAIAction"),$=document.getElementById("screenshotEnableImageGen"),L=document.getElementById("imageGenProvider"),K=document.getElementById("customImageGenUrl"),ee=document.getElementById("customImageGenUrlGroup"),F=document.getElementById("imageSize");let q=!1,B="Alt+Tab";const Y=await j(),h=Y.config,y=h.screenshot||E;u=Y.globalMenuItems,u=re(u,C),e.value=h.apiProvider,o.value=h.apiKey||"",t.value=h.customApiUrl||"",r.value=h.customModel||"",l.checked=h.useStreaming??!0,g.value=h.preferredLanguage,p.value=h.popoverPosition||"above",f.value=h.theme,B=h.shortcut||"Alt+Tab",N(B),O(h.apiProvider),P.checked=y.saveToFile,T.checked=y.copyToClipboard,U.checked=y.enableAI,D.value=y.defaultAIAction,$.checked=y.enableImageGen,L.value=y.imageGenProvider,K.value=y.customImageGenUrl||"",F.value=y.imageSize,_(y.imageGenProvider),M("globalMenuList",u),ie(),(Q=document.getElementById("addGlobalItem"))==null||Q.addEventListener("click",()=>{A=null,Z("添加自定义菜单项")}),e.addEventListener("change",()=>{O(e.value)});function O(a){const d=a==="custom";n.style.display=d?"block":"none",s.style.display=d?"block":"none",a==="groq"?c.textContent="使用 Groq 免费服务无需配置 API Key":d?c.textContent="如果你的 API 需要认证，请填写 API Key":c.textContent=`请填写你的 ${a.toUpperCase()} API Key`}function _(a){const d=a==="custom";ee.style.display=d?"block":"none"}L==null||L.addEventListener("change",()=>{_(L.value)}),m==null||m.addEventListener("click",()=>{q?H():te()});function te(){q=!0,m.textContent="取消录制",m.classList.add("bg-red-500/20","border-red-500","text-red-400"),i.classList.add("border-2","border-blue-500","bg-blue-500/10","animate-pulse"),z.textContent="请按下快捷键组合... (ESC 取消)",document.addEventListener("keydown",V)}function H(){q=!1,m.textContent="录制快捷键",m.classList.remove("bg-red-500/20","border-red-500","text-red-400"),i.classList.remove("border-2","border-blue-500","bg-blue-500/10","animate-pulse"),z.textContent='点击"录制快捷键"按钮，然后按下你想要的快捷键组合',document.removeEventListener("keydown",V)}function V(a){if(a.preventDefault(),a.stopPropagation(),a.key==="Escape"){H();return}const d=[];(a.ctrlKey||a.metaKey)&&d.push("Ctrl"),a.altKey&&d.push("Alt"),a.shiftKey&&d.push("Shift");const I=a.key;if(!["Control","Alt","Shift","Meta"].includes(I)){const R=I===" "?"Space":I.length===1?I.toUpperCase():I;d.push(R),d.length>=2&&(B=d.join("+"),N(B),H(),b("快捷键已设置，请点击保存按钮"))}}function N(a){if(i){const d=a.split("+");i.innerHTML=d.map((I,R)=>{const oe=R<d.length-1?'<span class="text-base text-white/50">+</span>':"";return`<span class="px-4 py-2 rounded-md text-sm font-semibold bg-white/10 border border-white/20">${I}</span>${oe}`}).join("")}}x==null||x.addEventListener("click",async()=>{const a=e.value;if(a==="custom"){if(!t.value){b("请填写自定义 API URL","error");return}if(!r.value){b("请填写模型名称","error");return}try{new URL(t.value)}catch{b("API URL 格式不正确","error");return}}const d={saveToFile:P.checked,copyToClipboard:T.checked,enableAI:U.checked,defaultAIAction:D.value,imageQuality:.92,enableImageGen:$.checked,imageGenProvider:L.value,customImageGenUrl:K.value||void 0,imageSize:F.value},I={apiProvider:a,apiKey:o.value||void 0,customApiUrl:t.value||void 0,customModel:r.value||void 0,useStreaming:l.checked,preferredLanguage:g.value,popoverPosition:p.value,theme:f.value,shortcut:B,screenshot:d};await J(I),await W(u),b("设置已保存","success")}),v==null||v.addEventListener("click",async()=>{await J(w),await W(C),e.value=w.apiProvider,o.value="",t.value="",r.value="",l.checked=w.useStreaming,g.value=w.preferredLanguage,p.value=w.popoverPosition||"above",f.value=w.theme,B=w.shortcut,N(B),O(w.apiProvider),P.checked=E.saveToFile,T.checked=E.copyToClipboard,U.checked=E.enableAI,D.value=E.defaultAIAction,$.checked=E.enableImageGen,L.value=E.imageGenProvider,K.value="",F.value=E.imageSize,_(E.imageGenProvider),u=[...C],M("globalMenuList",u),b("已重置为默认设置","success")})});function re(e,o){return e.map((t,r)=>{const n=o.find(s=>s.id===t.id);return{...t,enabled:t.enabled??!0,order:t.order??(n==null?void 0:n.order)??r}})}function M(e,o){const t=document.getElementById(e);if(!t)return;const r=[...o].sort((n,s)=>n.order-s.order);t.innerHTML=r.map(n=>{const s=n.isCustom;return`
      <div class="flex items-center gap-3 px-3 py-2.5 rounded-lg bg-white/5 border border-white/10 transition-all duration-150 cursor-grab hover:bg-white/10 hover:border-white/15 menu-item-config" draggable="true" data-id="${n.id}">
        <span class="text-sm cursor-grab text-white/30 select-none tracking-widest hover:text-white/50 drag-handle">⋮⋮</span>
        <span class="flex items-center justify-center w-[28px] h-[28px] rounded-md bg-white/10 text-white/80 item-icon">${n.customIcon||n.icon}</span>
        <span class="flex-1 text-sm font-medium text-white/90 item-label">${n.customLabel||n.label}</span>
        <span class="text-xs px-2 py-0.5 rounded bg-white/10 text-white/50 item-action">${n.action}</span>
        <div class="flex items-center gap-2 item-actions">
          ${s?`
            <button class="p-1.5 rounded cursor-pointer border-none bg-transparent text-white/40 transition-all duration-150 hover:bg-white/10 hover:text-white/80 item-btn edit" data-id="${n.id}" title="编辑">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                <path d="M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z"/>
              </svg>
            </button>
            <button class="p-1.5 rounded cursor-pointer border-none bg-transparent text-white/40 transition-all duration-150 hover:bg-red-500/20 hover:text-red-500 item-btn delete" data-id="${n.id}" title="删除">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
              </svg>
            </button>
          `:""}
          <label class="relative inline-block w-[36px] h-[20px] toggle-switch small">
            <input type="checkbox" ${n.enabled?"checked":""} data-id="${n.id}" class="opacity-0 w-0 h-0 peer sr-only">
            <span class="absolute inset-0 cursor-pointer rounded-full bg-white/15 transition-all duration-250 before:absolute before:rounded-full before:h-[14px] before:w-[14px] before:left-[3px] before:bottom-[3px] before:bg-white/70 before:transition-all before:duration-250 peer-checked:bg-blue-500 peer-checked:before:translate-x-[16px] peer-checked:before:bg-white toggle-slider"></span>
          </label>
        </div>
      </div>
    `}).join(""),se(e),le(e),ae(e)}function se(e){const o=document.getElementById(e);if(!o)return;const t=o.querySelectorAll(".menu-item-config");let r=null;t.forEach(n=>{const s=n;s.addEventListener("dragstart",c=>{r=s,s.classList.add("opacity-50","cursor-grabbing","dragging"),c.dataTransfer.effectAllowed="move"}),s.addEventListener("dragend",()=>{s.classList.remove("opacity-50","cursor-grabbing","dragging"),r=null,ce(e)}),s.addEventListener("dragover",c=>{c.preventDefault(),c.dataTransfer.dropEffect="move",s.classList.add("border-blue-500/50","bg-blue-500/10","drag-over")}),s.addEventListener("dragleave",()=>{s.classList.remove("border-blue-500/50","bg-blue-500/10","drag-over")}),s.addEventListener("drop",c=>{if(c.preventDefault(),s.classList.remove("border-blue-500/50","bg-blue-500/10","drag-over"),r&&r!==s){const l=s.getBoundingClientRect(),g=l.top+l.height/2;c.clientY<g?o.insertBefore(r,s):o.insertBefore(r,s.nextSibling)}})})}function ce(e){const o=document.getElementById(e);if(!o)return;o.querySelectorAll(".menu-item-config").forEach((r,n)=>{const s=r.dataset.id,c=u.find(l=>l.id===s);c&&(c.order=n)})}function le(e){const o=document.getElementById(e);if(!o)return;o.querySelectorAll(".toggle-switch input").forEach(r=>{r.addEventListener("change",n=>{const s=n.target,c=s.dataset.id,l=u.find(g=>g.id===c);l&&(l.enabled=s.checked)})})}function ae(e){const o=document.getElementById(e);o&&(o.querySelectorAll(".item-btn.edit").forEach(t=>{t.addEventListener("click",()=>{const r=t.dataset.id;if(r){A=r;const n=u.find(s=>s.id===r);n&&Z("编辑自定义菜单项",n)}})}),o.querySelectorAll(".item-btn.delete").forEach(t=>{t.addEventListener("click",()=>{const r=t.dataset.id;r&&(u=u.filter(n=>n.id!==r),M("globalMenuList",u),b("菜单项已删除"))})}))}function ie(){const e=document.getElementById("customItemModal"),o=document.getElementById("modalClose"),t=document.getElementById("cancelCustomItem"),r=document.getElementById("saveCustomItem"),n=document.getElementById("customItemAction"),s=document.getElementById("customPromptGroup"),c=document.getElementById("customUrlGroup");de(),o==null||o.addEventListener("click",k),t==null||t.addEventListener("click",k),e==null||e.addEventListener("click",l=>{l.target===e&&k()}),n==null||n.addEventListener("change",()=>{const l=n.value;s&&(s.style.display=l==="customAI"?"block":"none"),c&&(c.style.display=l==="openUrl"?"block":"none")}),r==null||r.addEventListener("click",()=>{const l=document.getElementById("selectedIcon").value,g=document.getElementById("customItemLabel").value.trim(),p=document.getElementById("customItemAction").value,f=document.getElementById("customPrompt").value.trim(),x=document.getElementById("customUrl").value.trim();if(!l){b("请选择一个图标","error");return}if(!g){b("请输入菜单项名称","error");return}if(p==="customAI"&&!f){b("请输入 AI 提示词","error");return}if(p==="openUrl"&&!x){b("请输入链接地址","error");return}const v=S[l];if(A){const i=u.find(m=>m.id===A);i&&(i.icon=v,i.label=g,i.action=p,p==="customAI"&&(i.customPrompt=f))}else{const i={id:`custom_${Date.now()}`,icon:v,label:g,action:p,enabled:!0,order:u.length,isCustom:!0,customPrompt:p==="customAI"?f:void 0};u.push(i)}M("globalMenuList",u),k(),b(A?"菜单项已更新":"菜单项已添加","success")})}function de(){const e=document.getElementById("iconPicker");if(!e)return;const o=Object.keys(S);e.innerHTML=o.map(t=>`
    <div class="flex items-center justify-center w-9 h-9 rounded-lg cursor-pointer bg-white/5 border-2 border-transparent text-white/70 transition-all duration-150 hover:bg-white/10 hover:text-white/90 icon-option" data-icon="${t}" title="${t}">
      ${S[t]}
    </div>
  `).join(""),e.querySelectorAll(".icon-option").forEach(t=>{t.addEventListener("click",()=>{e.querySelectorAll(".icon-option").forEach(r=>r.classList.remove("border-blue-500","bg-blue-500/20","text-white","selected")),t.classList.add("border-blue-500","bg-blue-500/20","text-white","selected"),document.getElementById("selectedIcon").value=t.dataset.icon||""})})}function Z(e,o){var x;const t=document.getElementById("customItemModal"),r=document.getElementById("modalTitle"),n=document.getElementById("selectedIcon"),s=document.getElementById("customItemLabel"),c=document.getElementById("customItemAction"),l=document.getElementById("customPrompt"),g=document.getElementById("customUrl"),p=document.getElementById("customPromptGroup"),f=document.getElementById("customUrlGroup");if(r&&(r.textContent=e),o){const v=((x=Object.entries(S).find(([i,m])=>m===o.icon))==null?void 0:x[0])||"";n.value=v,document.querySelectorAll(".icon-option").forEach(i=>{const m=i.dataset.icon===v;i.classList.toggle("selected",m),m?i.classList.add("border-blue-500","bg-blue-500/20","text-white"):i.classList.remove("border-blue-500","bg-blue-500/20","text-white")}),s.value=o.label,c.value=o.action,l.value=o.customPrompt||""}else n.value="",document.querySelectorAll(".icon-option").forEach(v=>v.classList.remove("border-blue-500","bg-blue-500/20","text-white","selected")),s.value="",c.value="customAI",l.value="",g.value="";p&&(p.style.display=c.value==="customAI"?"block":"none"),f&&(f.style.display=c.value==="openUrl"?"block":"none"),t==null||t.classList.add("show")}function k(){const e=document.getElementById("customItemModal");e==null||e.classList.remove("show"),A=null}function b(e,o="success"){const t=document.getElementById("toast");if(t){t.textContent=e;const r=o==="success"?"border-green-500/50":"border-red-500/50";t.className=`fixed bottom-6 left-1/2 px-5 py-3 text-sm rounded-lg pointer-events-none -translate-x-1/2 bg-[#1e1e1e]/95 border text-white/90 shadow-lg transition-all duration-250 backdrop-blur-sm z-[2000] opacity-100 translate-y-0 ${r}`,setTimeout(()=>{t.className="fixed bottom-6 left-1/2 px-5 py-3 text-sm rounded-lg pointer-events-none -translate-x-1/2 translate-y-[100px] bg-[#1e1e1e]/95 border border-white/15 text-white/90 shadow-lg opacity-0 transition-all duration-250 backdrop-blur-sm z-[2000]"},2500)}}
