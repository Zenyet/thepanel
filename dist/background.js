const g={groq:{apiUrl:"https://api.groq.com/openai/v1/chat/completions",model:"llama-3.2-90b-vision-preview",visionModel:"llama-3.2-90b-vision-preview"},openai:{apiUrl:"https://api.openai.com/v1/chat/completions",model:"gpt-4o-mini",visionModel:"gpt-4o-mini"},anthropic:{apiUrl:"https://api.anthropic.com/v1/messages",model:"claude-3-5-sonnet-20241022",visionModel:"claude-3-5-sonnet-20241022"},gemini:{apiUrl:"https://generativelanguage.googleapis.com/v1beta/models",model:"gemini-1.5-flash",visionModel:"gemini-1.5-flash"}};async function S(e,s,t,r,n){const a=t.apiProvider,o=t.useStreaming&&!!r;if(a!=="groq"&&!t.apiKey)return{success:!1,error:`请配置 ${a.toUpperCase()} API Key`};if(a==="custom"&&(!t.customApiUrl||!t.customModel))return{success:!1,error:"请配置自定义 API URL 和模型名称"};try{switch(a){case"anthropic":return await C(e,s,t,o,r,n);case"gemini":return await z(e,s,t,o,r,n);case"groq":case"openai":case"custom":default:return await M(e,s,t,o,r,n)}}catch(c){return c.name==="AbortError"?{success:!1,error:"请求已取消"}:{success:!1,error:`请求失败: ${c}`}}}async function M(e,s,t,r,n,a){var p,m,y;const o=t.apiProvider;let c,i,u=t.apiKey;if(o==="custom")c=t.customApiUrl,i=t.customModel;else{const h=g[o];c=h.apiUrl,i=h.model}const l=await fetch(c,{method:"POST",headers:{"Content-Type":"application/json",...u&&{Authorization:`Bearer ${u}`}},body:JSON.stringify({model:i,messages:[{role:"system",content:s},{role:"user",content:e}],temperature:.7,max_tokens:2048,stream:r}),signal:a});if(!l.ok)return{success:!1,error:`API 错误: ${await l.text()}`};if(r&&n)return await x(l,n,a);const f=(y=(m=(p=(await l.json()).choices)==null?void 0:p[0])==null?void 0:m.message)==null?void 0:y.content;return f?{success:!0,result:f}:{success:!1,error:"AI 无响应"}}async function x(e,s,t){var o,c,i,u;const r=(o=e.body)==null?void 0:o.getReader();if(!r)return{success:!1,error:"无法读取流"};const n=new TextDecoder;let a="";try{for(;;){if(t!=null&&t.aborted)return r.cancel(),{success:!1,error:"请求已取消"};const{done:l,value:d}=await r.read();if(l)break;const p=n.decode(d,{stream:!0}).split(`
`).filter(m=>m.trim()!=="");for(const m of p)if(m.startsWith("data: ")){const y=m.slice(6);if(y==="[DONE]")continue;try{const w=(u=(i=(c=JSON.parse(y).choices)==null?void 0:c[0])==null?void 0:i.delta)==null?void 0:u.content;w&&(a+=w,s(w,a))}catch{}}}return a?{success:!0,result:a}:{success:!1,error:"AI 无响应"}}finally{r.releaseLock()}}async function C(e,s,t,r,n,a){var l,d;const o=g.anthropic,c=await fetch(o.apiUrl,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":t.apiKey,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:o.model,max_tokens:2048,system:s,messages:[{role:"user",content:e}],stream:r}),signal:a});if(!c.ok)return{success:!1,error:`API 错误: ${await c.text()}`};if(r&&n)return await O(c,n,a);const u=(d=(l=(await c.json()).content)==null?void 0:l[0])==null?void 0:d.text;return u?{success:!0,result:u}:{success:!1,error:"AI 无响应"}}async function O(e,s,t){var o,c;const r=(o=e.body)==null?void 0:o.getReader();if(!r)return{success:!1,error:"无法读取流"};const n=new TextDecoder;let a="";try{for(;;){if(t!=null&&t.aborted)return r.cancel(),{success:!1,error:"请求已取消"};const{done:i,value:u}=await r.read();if(i)break;const d=n.decode(u,{stream:!0}).split(`
`).filter(f=>f.trim()!=="");for(const f of d)if(f.startsWith("data: ")){const p=f.slice(6);try{const m=JSON.parse(p);if(m.type==="content_block_delta"&&((c=m.delta)!=null&&c.text)){const y=m.delta.text;a+=y,s(y,a)}}catch{}}}return a?{success:!0,result:a}:{success:!1,error:"AI 无响应"}}finally{r.releaseLock()}}async function z(e,s,t,r,n,a){var f,p,m,y,h;const o=g.gemini,c=r?"streamGenerateContent":"generateContent",i=`${o.apiUrl}/${o.model}:${c}?key=${t.apiKey}${r?"&alt=sse":""}`,u=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:`${s}

${e}`}]}],generationConfig:{temperature:.7,maxOutputTokens:2048}}),signal:a});if(!u.ok)return{success:!1,error:`API 错误: ${await u.text()}`};if(r&&n)return await k(u,n,a);const d=(h=(y=(m=(p=(f=(await u.json()).candidates)==null?void 0:f[0])==null?void 0:p.content)==null?void 0:m.parts)==null?void 0:y[0])==null?void 0:h.text;return d?{success:!0,result:d}:{success:!1,error:"AI 无响应"}}async function k(e,s,t){var o,c,i,u,l,d;const r=(o=e.body)==null?void 0:o.getReader();if(!r)return{success:!1,error:"无法读取流"};const n=new TextDecoder;let a="";try{for(;;){if(t!=null&&t.aborted)return r.cancel(),{success:!1,error:"请求已取消"};const{done:f,value:p}=await r.read();if(f)break;const y=n.decode(p,{stream:!0}).split(`
`).filter(h=>h.trim()!=="");for(const h of y)if(h.startsWith("data: ")){const w=h.slice(6);try{const A=(d=(l=(u=(i=(c=JSON.parse(w).candidates)==null?void 0:c[0])==null?void 0:i.content)==null?void 0:u.parts)==null?void 0:l[0])==null?void 0:d.text;A&&(a+=A,s(A,a))}catch{}}}return a?{success:!0,result:a}:{success:!1,error:"AI 无响应"}}finally{r.releaseLock()}}async function _(e,s,t,r,n){const a=t.apiProvider,o=t.useStreaming&&!!r;if(a!=="groq"&&!t.apiKey)return{success:!1,error:`请配置 ${a.toUpperCase()} API Key`};try{switch(a){case"anthropic":return await L(e,s,t,o,r,n);case"gemini":return await K(e,s,t,o,r,n);case"groq":case"openai":default:return await G(e,s,t,o,r,n)}}catch(c){return c.name==="AbortError"?{success:!1,error:"请求已取消"}:{success:!1,error:`请求失败: ${c}`}}}async function G(e,s,t,r,n,a){var m,y,h;const o=t.apiProvider,c=g[o]||g.openai,i=c.apiUrl,u=c.visionModel||c.model,l=t.apiKey,d=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json",...l&&{Authorization:`Bearer ${l}`}},body:JSON.stringify({model:u,messages:[{role:"user",content:[{type:"text",text:s},{type:"image_url",image_url:{url:e}}]}],max_tokens:2048,stream:r}),signal:a});if(!d.ok)return{success:!1,error:`API 错误: ${await d.text()}`};if(r&&n)return await x(d,n,a);const p=(h=(y=(m=(await d.json()).choices)==null?void 0:m[0])==null?void 0:y.message)==null?void 0:h.content;return p?{success:!0,result:p}:{success:!1,error:"AI 无响应"}}async function L(e,s,t,r,n,a){var p,m;const o=g.anthropic,c=e.match(/^data:([^;]+);base64,(.+)$/);if(!c)return{success:!1,error:"无效的图片数据格式"};const[,i,u]=c,l=await fetch(o.apiUrl,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":t.apiKey,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:o.visionModel,max_tokens:2048,messages:[{role:"user",content:[{type:"image",source:{type:"base64",media_type:i,data:u}},{type:"text",text:s}]}],stream:r}),signal:a});if(!l.ok)return{success:!1,error:`API 错误: ${await l.text()}`};if(r&&n)return await O(l,n,a);const f=(m=(p=(await l.json()).content)==null?void 0:p[0])==null?void 0:m.text;return f?{success:!0,result:f}:{success:!1,error:"AI 无响应"}}async function K(e,s,t,r,n,a){var h,w,I,A,T;const o=g.gemini,c=o.visionModel,i=r?"streamGenerateContent":"generateContent",u=`${o.apiUrl}/${c}:${i}?key=${t.apiKey}${r?"&alt=sse":""}`,l=e.match(/^data:([^;]+);base64,(.+)$/);if(!l)return{success:!1,error:"无效的图片数据格式"};const[,d,f]=l,p=await fetch(u,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{inline_data:{mime_type:d,data:f}},{text:s}]}],generationConfig:{temperature:.7,maxOutputTokens:2048}}),signal:a});if(!p.ok)return{success:!1,error:`API 错误: ${await p.text()}`};if(r&&n)return await k(p,n,a);const y=(T=(A=(I=(w=(h=(await p.json()).candidates)==null?void 0:h[0])==null?void 0:w.content)==null?void 0:I.parts)==null?void 0:A[0])==null?void 0:T.text;return y?{success:!0,result:y}:{success:!1,error:"AI 无响应"}}async function j(e,s,t){const r=t.imageGenProvider;return r==="openai"?await D(e,s,t):r==="custom"&&t.customImageGenUrl?await q(e,t):{success:!1,error:"请配置图像生成服务"}}async function D(e,s,t){var r,n;if(!s.apiKey)return{success:!1,error:"请配置 OpenAI API Key"};try{const a=await fetch("https://api.openai.com/v1/images/generations",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s.apiKey}`},body:JSON.stringify({model:"dall-e-3",prompt:e,n:1,size:t.imageSize,response_format:"url"})});if(!a.ok)return{success:!1,error:`API 错误: ${await a.text()}`};const c=(n=(r=(await a.json()).data)==null?void 0:r[0])==null?void 0:n.url;return c?{success:!0,imageUrl:c}:{success:!1,error:"图像生成失败"}}catch(a){return{success:!1,error:`请求失败: ${a}`}}}async function q(e,s){var t,r;if(!s.customImageGenUrl)return{success:!1,error:"请配置自定义图像生成 API URL"};try{const n=await fetch(s.customImageGenUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:e,size:s.imageSize})});if(!n.ok)return{success:!1,error:`API 错误: ${await n.text()}`};const a=await n.json(),o=((r=(t=a.data)==null?void 0:t[0])==null?void 0:r.url)||a.url||a.image_url||a.result;return o?{success:!0,imageUrl:o}:{success:!1,error:"图像生成失败"}}catch(n){return{success:!1,error:`请求失败: ${n}`}}}function E(e){return`You are a professional translator. Translate the following text to ${e}. Only output the translation, nothing else.`}function P(e){const s=e.trim();return s?{auto:"the same language as the input","zh-CN":"Simplified Chinese","zh-TW":"Traditional Chinese",en:"English",ja:"Japanese",ko:"Korean",es:"Spanish",fr:"French",de:"German"}[s]||s:e}function U(e="auto"){return e==="auto"?"You are a summarization expert. Summarize the following text in a concise manner, keeping the key points. Use bullet points if appropriate. Output in the same language as the input.":`You are a summarization expert. Summarize the following text in a concise manner, keeping the key points. Use bullet points if appropriate. Output in ${P(e)}.`}function v(){return"You are a helpful teacher. Explain the following text in simple terms that anyone can understand. Output in the same language as the input."}function R(){return"You are a professional editor. Rewrite the following text to make it clearer, more engaging, and well-structured. Keep the same meaning. Output in the same language as the input."}function N(){return"You are a senior software engineer. Explain the following code in detail, including what it does, how it works, and any important concepts. Output in the same language as the input text (if any) or in English."}function $(e="auto"){return e==="auto"?"You are a summarization expert. Summarize the following webpage content in a comprehensive but concise manner. Include the main topic, key points, and any important details. Use bullet points for clarity. Output in the same language as the content.":`You are a summarization expert. Summarize the following webpage content in a comprehensive but concise manner. Include the main topic, key points, and any important details. Use bullet points for clarity. Output in ${P(e)}.`}chrome.runtime.onMessage.addListener((e,s,t)=>(V(e).then(t).catch(r=>t({success:!1,error:String(r)})),!0));const b=new Map;chrome.runtime.onConnect.addListener(e=>{if(e.name==="ai-stream"){const s=new AbortController;b.set(e,s),e.onDisconnect.addListener(()=>{const t=b.get(e);t&&(t.abort(),b.delete(e))}),e.onMessage.addListener(async t=>{const r=s.signal;t.type==="AI_REQUEST"?await B(e,t.payload,r):t.type==="AI_VISION_REQUEST"&&await Y(e,t.payload,r),b.delete(e)})}});async function V(e,s){switch(e.type){case"AI_REQUEST":return J(e.payload);case"AI_VISION_REQUEST":return W(e.payload);case"AI_IMAGE_GEN_REQUEST":return Q(e.payload);case"GET_TABS":return H();case"SWITCH_TAB":return F(e.payload);case"NEW_TAB":return X();case"SCREENSHOT":return Z();case"CAPTURE_VISIBLE_TAB":return ee();case"DOWNLOAD_IMAGE":return te(e.payload);case"ADD_BOOKMARK":return re(e.payload);case"OPEN_URL":return ae(e.payload);default:return{success:!1,error:"Unknown message type"}}}async function J(e){const{action:s,text:t,config:r,systemPrompt:n}=e;let a;if(n)a=n;else switch(s){case"translate":a=E(r.preferredLanguage||"zh-CN");break;case"summarize":a=U(r.summaryLanguage||"auto");break;case"explain":a=v();break;case"rewrite":a=R();break;case"codeExplain":a=N();break;case"summarizePage":a=$(r.summaryLanguage||"auto");break;default:return{success:!1,error:"Unknown AI action"}}return S(t,a,r)}async function B(e,s,t){const{action:r,text:n,config:a,requestId:o,systemPrompt:c}=s;let i;if(c)i=c;else switch(r){case"translate":i=E(a.preferredLanguage||"zh-CN");break;case"summarize":i=U(a.summaryLanguage||"auto");break;case"explain":i=v();break;case"rewrite":i=R();break;case"codeExplain":i=N();break;case"summarizePage":i=$(a.summaryLanguage||"auto");break;default:e.postMessage({type:"AI_STREAM_ERROR",payload:{requestId:o,error:"Unknown AI action"}});return}try{const u=await S(n,i,a,(l,d)=>{t.aborted||e.postMessage({type:"AI_STREAM_CHUNK",payload:{requestId:o,chunk:l,fullText:d}})},t);t.aborted||e.postMessage({type:"AI_STREAM_END",payload:{requestId:o,...u}})}catch(u){t.aborted||e.postMessage({type:"AI_STREAM_ERROR",payload:{requestId:o,error:String(u)}})}}async function W(e){const{imageDataUrl:s,prompt:t,config:r}=e;return _(s,t,r)}async function Y(e,s,t){const{imageDataUrl:r,prompt:n,config:a,requestId:o}=s;try{const c=await _(r,n,a,(i,u)=>{t.aborted||e.postMessage({type:"AI_STREAM_CHUNK",payload:{requestId:o,chunk:i,fullText:u}})},t);t.aborted||e.postMessage({type:"AI_STREAM_END",payload:{requestId:o,...c}})}catch(c){t.aborted||e.postMessage({type:"AI_STREAM_ERROR",payload:{requestId:o,error:String(c)}})}}async function Q(e){const{prompt:s,config:t,screenshotConfig:r}=e;return j(s,t,r)}async function H(){try{return{success:!0,tabs:await chrome.tabs.query({currentWindow:!0})}}catch{return{success:!1}}}async function F(e){try{return await chrome.tabs.update(e,{active:!0}),{success:!0}}catch{return{success:!1}}}async function X(){try{return await chrome.tabs.create({}),{success:!0}}catch{return{success:!1}}}async function Z(){try{const e=await chrome.tabs.captureVisibleTab(),s=`screenshot-${Date.now()}.png`;return await chrome.downloads.download({url:e,filename:s,saveAs:!1}),{success:!0,dataUrl:e}}catch(e){return{success:!1,error:String(e)}}}async function ee(){try{return{success:!0,dataUrl:await chrome.tabs.captureVisibleTab()}}catch(e){return{success:!1,error:String(e)}}}async function te(e){try{return await chrome.downloads.download({url:e.dataUrl,filename:e.filename,saveAs:!1}),{success:!0}}catch(s){return{success:!1,error:String(s)}}}async function re(e){try{return await chrome.bookmarks.create({title:e.title,url:e.url}),{success:!0}}catch{return{success:!1}}}async function ae(e){try{return await chrome.tabs.create({url:e}),{success:!0}}catch{return{success:!1}}}chrome.action.onClicked.addListener(async e=>{e.id&&await chrome.tabs.sendMessage(e.id,{type:"TOGGLE_MENU"})});chrome.commands.onCommand.addListener(async e=>{if(e==="_execute_action"){const[s]=await chrome.tabs.query({active:!0,currentWindow:!0});s!=null&&s.id&&await chrome.tabs.sendMessage(s.id,{type:"TOGGLE_MENU"})}});console.log("The Circle: Background service worker initialized");
